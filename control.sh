#!/bin/bash

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Facebook Live Stream - Control Panel
# Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/config.sh" 2>/dev/null || SESSION_NAME="fbstream"

# Ø§Ù„Ø£Ù„ÙˆØ§Ù†
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¯ÙˆØ§Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print_header() {
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘${NC}  ğŸ¥ Facebook Live Stream - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…  ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
}

log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

get_stream_status() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo "running"
    else
        echo "stopped"
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

start_stream() {
    local status=$(get_stream_status)
    
    if [ "$status" = "running" ]; then
        log_warning "Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„ Ø¨Ø§Ù„ÙØ¹Ù„!"
        log_info "Ø§Ø³ØªØ®Ø¯Ù… 'restart' Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„"
        return 1
    fi
    
    log_info "Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«..."
    bash "$SCRIPT_DIR/main.sh"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

stop_stream() {
    local status=$(get_stream_status)
    
    if [ "$status" = "stopped" ]; then
        log_warning "Ø§Ù„Ø¨Ø« Ù…ØªÙˆÙ‚Ù Ø¨Ø§Ù„ÙØ¹Ù„"
        return 1
    fi
    
    log_info "Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«..."
    tmux kill-session -t "$SESSION_NAME" 2>/dev/null
    
    sleep 1
    
    if [ "$(get_stream_status)" = "stopped" ]; then
        log_success "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­"
    else
        log_error "ÙØ´Ù„ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«"
        return 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

restart_stream() {
    log_info "Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«..."
    
    if [ "$(get_stream_status)" = "running" ]; then
        stop_stream
        sleep 2
    fi
    
    start_stream
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_status() {
    local status=$(get_stream_status)
    
    echo ""
    echo -e "${CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${CYAN}â•‘${NC}            ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ø­Ø§Ù„ÙŠØ©           ${CYAN}â•‘${NC}"
    echo -e "${CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    if [ "$status" = "running" ]; then
        echo -e "${GREEN}ğŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØ¹Ù…Ù„ (RUNNING)${NC}"
        echo ""
        
        if command -v pgrep &> /dev/null && pgrep -f "ffmpeg.*$SESSION_NAME" &> /dev/null; then
            local pid=$(pgrep -f "ffmpeg.*flv" | head -1)
            if [ -n "$pid" ]; then
                echo -e "${BLUE}ğŸ†” Process ID:${NC} $pid"
                
                if command -v ps &> /dev/null; then
                    local cpu=$(ps -p $pid -o %cpu --no-headers 2>/dev/null | tr -d ' ')
                    local mem=$(ps -p $pid -o %mem --no-headers 2>/dev/null | tr -d ' ')
                    local runtime=$(ps -p $pid -o etime --no-headers 2>/dev/null | tr -d ' ')
                    
                    [ -n "$cpu" ] && echo -e "${BLUE}ğŸ’» CPU:${NC} ${cpu}%"
                    [ -n "$mem" ] && echo -e "${BLUE}ğŸ§  RAM:${NC} ${mem}%"
                    [ -n "$runtime" ] && echo -e "${BLUE}â±ï¸  Ø§Ù„Ù…Ø¯Ø©:${NC} $runtime"
                fi
            fi
        fi
        
        if [ -d "logs" ] && [ "$(ls -A logs 2>/dev/null)" ]; then
            local latest_log=$(ls -t logs/*.log 2>/dev/null | head -1)
            if [ -n "$latest_log" ]; then
                echo -e "${BLUE}ğŸ“„ Ø¢Ø®Ø± Ù…Ù„Ù Ø³Ø¬Ù„:${NC} $latest_log"
            fi
        fi
        
        echo ""
        log_info "Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:"
        echo -e "  ${GREEN}tmux attach -t $SESSION_NAME${NC}"
        echo -e "  ${YELLOW}(Ø§Ø¶ØºØ· Ctrl+B Ø«Ù… D Ù„Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù)${NC}"
        
    else
        echo -e "${RED}ğŸ”´ Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªÙˆÙ‚Ù (STOPPED)${NC}"
        echo ""
        log_info "Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«:"
        echo -e "  ${GREEN}./control.sh start${NC}"
    fi
    
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_logs() {
    if [ ! -d "logs" ] || [ ! "$(ls -A logs 2>/dev/null)" ]; then
        log_warning "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¨Ø¹Ø¯"
        return 1
    fi
    
    local latest_log=$(ls -t logs/*.log 2>/dev/null | head -1)
    
    if [ -z "$latest_log" ]; then
        log_warning "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª"
        return 1
    fi
    
    log_info "Ø¹Ø±Ø¶ Ø¢Ø®Ø± 30 Ø³Ø·Ø± Ù…Ù† Ø§Ù„Ø³Ø¬Ù„..."
    echo ""
    tail -n 30 "$latest_log"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù„Ø³Ø© tmux
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

attach_stream() {
    local status=$(get_stream_status)
    
    if [ "$status" = "stopped" ]; then
        log_error "Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…Ø´ØºÙ„!"
        log_info "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø£ÙˆÙ„Ø§Ù‹: ./control.sh start"
        return 1
    fi
    
    log_info "Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨Ø«..."
    log_warning "Ù„Ù„Ø®Ø±ÙˆØ¬: Ø§Ø¶ØºØ· Ctrl+B Ø«Ù… D (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«)"
    sleep 2
    tmux attach -t "$SESSION_NAME"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

show_help() {
    print_header
    echo -e "${CYAN}Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:${NC}"
    echo -e "  ./control.sh ${GREEN}[command]${NC}"
    echo ""
    echo -e "${CYAN}Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:${NC}"
    echo ""
    echo -e "  ${GREEN}start${NC}        - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«"
    echo -e "  ${GREEN}stop${NC}         - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«"
    echo -e "  ${GREEN}restart${NC}      - Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø«"
    echo -e "  ${GREEN}status${NC}       - Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø«"
    echo -e "  ${GREEN}logs${NC}         - Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
    echo -e "  ${GREEN}attach${NC}       - Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¬Ù„Ø³Ø© Ø§Ù„Ø¨Ø«"
    echo -e "  ${GREEN}help${NC}         - Ø¹Ø±Ø¶ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"
    echo ""
    echo -e "${CYAN}Ø£Ù…Ø«Ù„Ø©:${NC}"
    echo -e "  ./control.sh start       ${BLUE}# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«${NC}"
    echo -e "  ./control.sh status      ${BLUE}# Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­Ø§Ù„Ø©${NC}"
    echo -e "  ./control.sh logs        ${BLUE}# Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª${NC}"
    echo ""
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interactive_menu() {
    while true; do
        print_header
        
        local status=$(get_stream_status)
        if [ "$status" = "running" ]; then
            echo -e "${GREEN}ğŸŸ¢ Ø§Ù„Ø­Ø§Ù„Ø©: ÙŠØ¹Ù…Ù„${NC}"
        else
            echo -e "${RED}ğŸ”´ Ø§Ù„Ø­Ø§Ù„Ø©: Ù…ØªÙˆÙ‚Ù${NC}"
        fi
        
        echo ""
        echo -e "${CYAN}Ø§Ø®ØªØ± Ø¹Ù…Ù„ÙŠØ©:${NC}"
        echo ""
        echo "  1) Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« (Start)"
        echo "  2) Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« (Stop)"
        echo "  3) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ (Restart)"
        echo "  4) Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© (Status)"
        echo "  5) Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Logs)"
        echo "  6) Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø« (Attach)"
        echo "  0) Ø®Ø±ÙˆØ¬ (Exit)"
        echo ""
        read -p "Ø§Ø®ØªÙŠØ§Ø±Ùƒ: " choice
        
        case $choice in
            1) start_stream; read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©..." ;;
            2) stop_stream; read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©..." ;;
            3) restart_stream; read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©..." ;;
            4) show_status; read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©..." ;;
            5) show_logs; read -p "Ø§Ø¶ØºØ· Enter Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©..." ;;
            6) attach_stream ;;
            0) log_info "Ù…Ø¹ Ø§Ù„Ø³Ù„Ø§Ù…Ø©! ğŸ‘‹"; exit 0 ;;
            *) log_error "Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­"; sleep 1 ;;
        esac
    done
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

main() {
    case "${1:-}" in
        start)
            print_header
            start_stream
            ;;
        stop)
            print_header
            stop_stream
            ;;
        restart)
            print_header
            restart_stream
            ;;
        status)
            print_header
            show_status
            ;;
        logs)
            print_header
            show_logs
            ;;
        attach)
            attach_stream
            ;;
        help|--help|-h)
            show_help
            ;;
        menu|"")
            interactive_menu
            ;;
        *)
            log_error "Ø£Ù…Ø± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
